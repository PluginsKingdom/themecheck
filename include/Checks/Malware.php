<?php
namespace ThemeCheck;

class Malware_Checker extends CheckPart
{
    public function doCheck($php_files, $php_files_filtered, $css_files, $other_files, $themeInfo)
    {
        $this->errorLevel = ERRORLEVEL_SUCCESS;
        
        foreach ( $php_files as $php_key => $phpfile )
        {
            if ( preg_match_all( $this->code, $phpfile, $matches ) )
            {
                $filename = tc_filename( $php_key );
                foreach ($matches[1] as $match )
                {
                    $error = ltrim( $match, '(' );
                    $error = rtrim( $error, '(' );
                    $grep = tc_grep( $error, $php_key );
                    $this->messages[] = __all('<strong>%1$s</strong> was found in the file <strong>%2$s</strong> %3$s', $error, $filename, $grep );
                    $this->errorLevel = $this->threatLevel;
                }
            } 
        }
    }
}

class Malware extends Check
{
		protected function createChecks()
    {
			$this->title = __all("Malware");
			$this->checks = array(
						new Malware_Checker('MALWARE1', TT_COMMON, ERRORLEVEL_CRITICAL, __all('Operations on file system'), '/[^a-z0-9](?<!_)(file_get_contents|readfile|fopen|fclose|fread|fwrite|file_put_contents)\s?\(/', 'ut_malware.zip'),
						new Malware_Checker('MALWARE2', TT_COMMON, ERRORLEVEL_CRITICAL, __all('Network operations'), '/[^a-z0-9](?<!_)(curl_exec|curl_init|fsockopen|pfsockopen)\s?\(/', 'ut_malware.zip'),
			);
    }
}